---
name: Deploy Apps ðŸš€

on:
  push:
  workflow_dispatch:

env:
  SHINYAPPSIO_ACCOUNT: vedha-viyash
  APP_PREFIX: NEST

jobs:
  deploy:
    defaults:
      run:
        shell: bash
    name: Publish ðŸ—ž
    runs-on: ubuntu-latest
    container:
      image: rocker/shiny
    strategy:
      fail-fast: false
      matrix:
        directory: ["basic-teal"]
        repository:
          [
            "https://insightsengineering.r-universe.dev",
            "https://pharmaverse.r-universe.dev",
          ]
    steps:
      - name: Set CHANNEL
        run: |
          if [ "${{ matrix.repository }}" = "https://insightsengineering.r-universe.dev" ]; then
            echo "CHANNEL=stable" >> $GITHUB_ENV
            echo "CODE_BRANCH=main" >> $GITHUB_ENV
          else
            echo "CHANNEL=release" >> $GITHUB_ENV
            echo "CODE_BRANCH=dev" >> $GITHUB_ENV
          fi

      - name: Checkout repo ðŸ›Ž
        uses: actions/checkout@v3
        with:
          path: ${{ github.event.repository.name }}
          ref:

      - name: Update the file
        shell: bash
        working-directory: ${{ github.event.repository.name }}/${{ matrix.directory }}/js
        run: |
          echo "some string" >> ${{ env.CODE_BRANCH }}.txt

      - name: Commit updated renv.lock file
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          repository: ${{ github.event.repository.name }}
          branch: main # TODO: switch to the release branch before merging.
          commit_message: "[bot] Update test file for ${{ matrix.repository }} app"
          file_pattern: "${{ env.CODE_BRANCH }}.txt"
          commit_user_name: insights-engineering-bot
